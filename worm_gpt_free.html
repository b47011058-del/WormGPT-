<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WormGPT</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCuMmTKC9/GdAwgaGsQV8iKFUxKjmbRDEGexBSR8rMvGbrzSVsYAccPNoT3JgA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        /* =================================================================== */
        /* 1. ROOT & GENERAL STYLES */
        /* =================================================================== */
        :root {
            --background-main: #000000;
            --background-secondary: #0d0d0d;
            --background-tertiary: #1a1a1a;
            --background-input: #2a2a2e;
            --background-user-msg: #004d99; 
            --background-assistant-msg: #2a2a2e;
            --border-color: #2c2c2c;
            --text-primary: #f0f0f0;
            --text-secondary: #9b9b9b;
            --accent-color: #4a90e2; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; font-size: 14px; touch-action: manipulation; }
        
        body {
            font-family: 'Cairo', sans-serif; 
            color: var(--text-primary);
            background-color: var(--background-main);
            display: flex; 
            justify-content: center; 
            align-items: center;
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: scale(0.98); } 
            to { opacity: 1; transform: scale(1); } 
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 8px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* =================================================================== */
        /* 2. AUTH & PROMO SCREEN STYLES (CARD DESIGN) */
        /* =================================================================== */
        .auth-card {
            display: none; /* Hidden by default, shown by JS */
            width: 100%;
            max-width: 400px;
            padding: 2.5rem 2rem; 
            text-align: center;
            animation: fadeIn 0.5s ease-out;
            background: var(--background-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .auth-card h2 { font-size: 2rem; margin-bottom: 0.5rem; }
        .auth-card p { color: var(--text-secondary); margin-bottom: 2rem; font-size: 1rem; }
        .auth-card .icon { font-size: 3rem; margin-bottom: 1.5rem; color: var(--text-secondary); }

        .auth-card input[type="text"],
        .auth-card input[type="password"] {
            width: 100%; padding: 14px 20px; border-radius: 24px; 
            border: 1px solid var(--border-color); background: var(--background-tertiary);
            color: var(--text-primary); font-size: 1rem;
            font-family: 'Cairo', sans-serif; text-align: center;
            margin-bottom: 1rem; /* Added spacing */
        }
        html[dir="ltr"] .auth-card input[type="text"],
        html[dir="ltr"] .auth-card input[type="password"] { text-align: left; }
        
        .auth-card input[type="text"]:focus,
        .auth-card input[type="password"]:focus {
            outline: none; border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.3);
        }
        
        .primary-button {
            width: 100%; padding: 14px; margin-top: 1rem;
            background: var(--accent-color); color: #fff; border: none;
            border-radius: 24px; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease; font-size: 1rem;
            font-family: 'Cairo', sans-serif; text-decoration: none; display: inline-block;
        }
        .primary-button:hover { background: #3a80d1; transform: translateY(-2px); }
        .primary-button:disabled { background: var(--background-tertiary); cursor: not-allowed; }
        
        .secondary-button {
            width: 100%; padding: 14px; margin-top: 0.75rem;
            background: transparent; color: var(--text-secondary);
            border: 1px solid var(--border-color); border-radius: 24px; 
            font-weight: 600; cursor: pointer; transition: all 0.3s ease;
            font-size: 1rem; font-family: 'Cairo', sans-serif;
        }
        .secondary-button:hover { background: var(--background-tertiary); color: var(--text-primary); }
        
        .contact-list { margin-bottom: 1.5rem; text-align: right; font-size: 0.95rem; color: var(--text-secondary); }
        html[dir="ltr"] .contact-list { text-align: left; }
        .contact-item { display: flex; align-items: center; justify-content: center; gap: 0.75rem; padding: 0.5rem 0; }
        .contact-item i { width: 20px; text-align: center; color: var(--accent-color); }
        
        .auth-switch-link {
            background: none;
            border: none;
            color: var(--accent-color);
            font-family: 'Cairo', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 1.5rem;
            display: inline-block;
        }
        .auth-switch-link:hover {
            text-decoration: underline;
        }
        
        .plan-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
            text-align: right;
        }
        html[dir="ltr"] .plan-container { text-align: left; }

        .plan-box {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
        }
        .plan-box.premium {
            border-color: var(--accent-color);
        }
        .plan-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            text-align: center;
        }
        .plan-box.premium .plan-title {
            color: var(--accent-color);
        }
        .plan-features {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 0.9rem;
        }
        .feature-item {
            margin-bottom: 0.5rem;
        }
        .feature-item.enabled {
            color: var(--text-primary);
        }
        .feature-item.disabled {
            color: var(--text-secondary);
            text-decoration: line-through;
        }

        /* =================================================================== */
        /* 3. CHAT CONTAINER & LAYOUT */
        /* =================================================================== */
        
        #chat-wrapper { 
            display: none; width: 100%; height: 100%;
            max-height: 100vh; position: relative; overflow: hidden; 
        }

        #chat-container {
            width: 100%; height: 100%; 
            background: var(--background-main); 
            display: flex; flex-direction: column; 
            overflow: hidden; max-width: 800px; 
            margin: 0 auto; 
            transition: transform 0.3s ease-in-out; 
        }
        
        /* =================================================================== */
        /* 4. SIDEBAR (MODIFIED FOR CHAT LIST) */
        /* =================================================================== */
        
        #sidebar {
            position: fixed; top: 0; right: 0; 
            width: 280px; height: 100%;
            background: var(--background-secondary);
            border-left: 1px solid var(--border-color);
            z-index: 1000; transform: translateX(100%); 
            transition: transform 0.3s ease-in-out;
            display: flex; flex-direction: column;
        }
        html[dir="ltr"] #sidebar {
            right: auto; left: 0;
            border-left: none;
            border-right: 1px solid var(--border-color);
            transform: translateX(-100%);
        }
        
        #sidebar.open { transform: translateX(0); }

        #sidebar-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s;
        }
        
        #sidebar-overlay.open { opacity: 1; visibility: visible; }
        .sidebar-header { padding: 1rem; border-bottom: 1px solid var(--border-color); font-size: 1.2rem; font-weight: 600; flex-shrink: 0; }
        
        .sidebar-content {
            padding: 0.5rem 0;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        .chat-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .chat-list-item:hover {
            background: var(--background-tertiary);
            color: var(--text-primary);
        }
        .chat-list-item.active {
            background: var(--accent-color);
            color: #fff;
            border-bottom-color: var(--accent-color);
        }
        
        .chat-list-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
            padding-left: 0.5rem; /* Space for RTL */
        }
        html[dir="ltr"] .chat-list-title {
            padding-left: 0;
            padding-right: 0.5rem;
        }

        .delete-chat-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .delete-chat-btn:hover {
            color: #e50914; /* Red */
            background: var(--background-tertiary);
        }
        .chat-list-item.active .delete-chat-btn {
            color: #fff;
        }
        .chat-list-item.active .delete-chat-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .sidebar-footer { padding: 1rem; border-top: 1px solid var(--border-color); flex-shrink: 0; }
        
        #logout-button {
            width: 100%; padding: 10px; background: #4a4a4a;
            color: #fff; border: none; border-radius: 8px;
            font-weight: 600; cursor: pointer; transition: all 0.3s ease;
            font-size: 0.9rem; font-family: 'Cairo', sans-serif;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        #logout-button:hover { background: #e50914; }

        /* =================================================================== */
        /* 5. UI ELEMENTS & CHAT INTERFACE */
        /* =================================================================== */

        .chat-header {
            padding: 0.8rem 1rem; display: flex; justify-content: space-between; 
            align-items: center; border-bottom: 1px solid var(--border-color); 
            flex-shrink: 0; background: var(--background-secondary); min-height: 60px;
        }
        
        #title { font-family: 'Cairo', sans-serif; font-size: 1.2rem; color: var(--text-primary); font-weight: 600; }
        
        .header-button {
            background: transparent; border: none; color: var(--text-secondary); 
            font-size: 1rem; cursor: pointer; padding: 0.5rem; border-radius: 8px; 
            transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem;
            -webkit-appearance: none;
        }
        .header-button:hover { color: var(--text-primary); background: var(--background-tertiary); }
        #new-chat-button span { font-size: 0.9rem; font-family: 'Cairo', sans-serif; }

        #chat-box { 
            flex-grow: 1; padding: 1rem; overflow-y: auto; 
            display: flex; flex-direction: column; gap: 0.6rem; 
            background: var(--background-main); position: relative;
        }
        
        #welcome-message {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; height: 100%; position: absolute;
            top: 0; left: 0; width: 100%; text-align: center;
            color: var(--text-secondary); padding-bottom: 60px; 
        }
        #welcome-message i { font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem; }
        #welcome-message h2 { font-size: 1.8rem; color: var(--text-primary); font-weight: 600; }

        .message {
            position: relative; padding: 0.6rem 1rem; border-radius: 16px; 
            max-width: 85%; line-height: 1.5; word-wrap: break-word; 
            font-family: 'Cairo', sans-serif; font-size: 0.9rem; 
            animation: fadeInMessage 0.4s ease-out; white-space: pre-wrap;
        }
        
        @keyframes fadeInMessage { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Message alignment and tail styling */
        .user-message { 
            background: var(--background-user-msg); 
            color: #fff; 
            align-self: flex-end; /* LTR: right */
            border-bottom-right-radius: 4px;
        }
        .assistant-message { 
            background: var(--background-assistant-msg); 
            border: 1px solid var(--border-color); 
            align-self: flex-start; /* LTR: left */
            border-bottom-left-radius: 4px; 
            color: var(--text-primary); 
        }

        html[dir="rtl"] .user-message {
            align-self: flex-start; /* RTL: right */
            border-bottom-right-radius: 16px;
            border-bottom-left-radius: 4px;
        }
        html[dir="rtl"] .assistant-message {
            align-self: flex-end; /* RTL: left */
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 4px;
        }
        
        .typing-indicator { display: flex; align-items: center; gap: 5px; padding: 10px 0; }
        .typing-indicator span { width: 8px; height: 8px; background-color: var(--text-secondary); border-radius: 50%; animation: typing-bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing-bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        
        .code-block-wrapper { position: relative; margin: 0.8rem 0; border-radius: 6px; overflow: hidden; }
        pre { background-color: #1c1d21; border-radius: 6px; padding: 1rem 0.8rem 0.8rem 0.8rem; overflow-x: auto; font-family: 'Fira Code', monospace; margin: 0; font-size: 0.8rem; text-align: left; direction: ltr;}
        .copy-code-btn { 
            position: absolute; top: 6px; right: 6px; background: rgba(0, 0, 0, 0.7); border: 1px solid #444;
            color: var(--text-secondary); border-radius: 4px; padding: 3px 6px; font-size: 0.7rem;
            cursor: pointer; transition: all 0.3s ease;
        }
        html[dir="ltr"] .copy-code-btn { right: auto; left: 6px; }

        .copy-code-btn:hover { color: var(--accent-color); border-color: var(--accent-color); background: rgba(0, 0, 0, 0.9); }

        #input-area {
            display: flex; padding: 0.6rem 0.8rem; margin: 0 1rem 1rem 1rem;
            border: 1px solid var(--border-color); background: var(--background-tertiary);
            border-radius: 24px; gap: 0.5rem; align-items: flex-end; 
            flex-shrink: 0; min-height: 56px;
        }
        #message-input {
            flex-grow: 1; padding: 10px 5px; border: none;
            background-color: transparent; color: var(--text-primary);
            font-family: 'Cairo', sans-serif; font-size: 0.95rem; 
            resize: none; transition: all 0.3s ease;
            max-height: 120px; outline: none; 
        }
        #message-input:focus { box-shadow: none; outline: none; }
        
        .input-btn {
            width: 40px; height: 40px; border: none; background-color: transparent; 
            color: var(--text-secondary); border-radius: 50%; cursor: pointer;
            font-size: 1rem; transition: all 0.3s ease; flex-shrink: 0; 
            display: flex; align-items: center; justify-content: center;
            -webkit-appearance: none;
        }
        .input-btn:hover { color: var(--text-primary); background-color: #333; }
        
        #send-button { background: var(--accent-color); color: #fff; }
        #send-button:hover { background: #3a80d1; }
        
        #send-button:disabled {
            background: var(--background-tertiary);
            color: var(--text-secondary);
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        #send-button:disabled:hover {
            background: var(--background-tertiary);
        }
        
        .message-actions {
            display: flex; align-items: center; justify-content: flex-start;
            gap: 0.25rem; margin-top: 0.75rem; margin-right: auto; 
        }
        html[dir="ltr"] .message-actions { margin-right: 0; margin-left: auto; }

        .action-btn {
            background: transparent; border: 1px solid var(--border-color);
            color: var(--text-secondary); width: 32px; height: 32px;
            border-radius: 50%; font-size: 0.8rem; cursor: pointer;
            transition: all 0.3s ease; display: flex;
            align-items: center; justify-content: center;
        }
        .action-btn:hover { background: var(--background-tertiary); color: var(--text-primary); }
        .action-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }
        .input-btn.recording { color: #ff4d4d; animation: pulse 1.5s infinite; }
        
        #toast-container { position: fixed; bottom: 15px; z-index: 1001; width: calc(100% - 30px); max-width: 350px; left: 50%; transform: translateX(-50%); }
        .toast {
            background: var(--background-tertiary); border: 1px solid var(--border-color); border-radius: 8px;
            padding: 10px 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transform: translateY(100px); opacity: 0;
            transition: all 0.4s ease; font-size: 0.9rem;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.error { border-left: 4px solid #e50914; }
        html[dir="ltr"] .toast.error { border-left: none; border-right: 4px solid #e50914; }
        .toast i { color: #e50914; }

        /* =================================================================== */
        /* 6. MOBILE OPTIMIZATIONS */
        /* =================================================================== */
        @media (max-width: 768px) {
            html, body { font-size: 14px; }
            #chat-container { max-width: 100%; border-radius: 0; }
            #chat-wrapper { height: 100vh; max-height: -webkit-fill-available; }
            .auth-card { height: 100vh; max-height: -webkit-fill-available; padding-left: 1rem; padding-right: 1rem; border-radius: 0; border: none; }
            .message { max-width: 95%; font-size: 0.9rem; }
            #title { font-size: 1.1rem; }
            .chat-header { padding: 0.8rem; }
            #new-chat-button span { display: none; }
            #chat-box { padding: 0.8rem; }
            #input-area { margin: 0 0.5rem 0.5rem 0.5rem; }
            .input-btn { width: 38px; height: 38px; }
            #welcome-message h2 { font-size: 1.5rem; }
            #welcome-message i { font-size: 2.5rem; }
            #sidebar { width: 260px; } 
        }
        
        @supports (-webkit-touch-callout: none) {
            #chat-container, #sidebar, .auth-card { height: -webkit-fill-available; }
        }
        
    </style>
</head>
<body>
    
    <div id="auth-wrapper" class="auth-card">
        <i class="fas fa-skull-crossbones icon"></i>
        <h2 data-translate-key="login_title">WormGPT ğŸ˜ˆ</h2>
        <p data-translate-key="login_subtitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
        <input type="text" id="login-username-input" data-translate-key-placeholder="login_username_placeholder" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙŠÙˆØ²Ø±)">
        <input type="password" id="login-password-input" data-translate-key-placeholder="login_password_placeholder" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button id="login-button" class="primary-button" data-translate-key="login_button">Ø¯Ø®ÙˆÙ„</button>
        <button id="show-forgot-btn" class="auth-switch-link" style="margin-top: 0.5rem;" data-translate-key="forgot_password_link">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</button>
        <button id="show-register-btn" class="auth-switch-link" data-translate-key="no_account_link">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
    </div>
    
    <div id="register-wrapper" class="auth-card">
        <i class="fas fa-user-plus icon"></i>
        <h2 data-translate-key="register_title">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
        <p data-translate-key="register_subtitle">ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„</p>
        <input type="text" id="register-name-input" data-translate-key-placeholder="register_name_placeholder" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù…Ø«Ø§Ù„: R3X)">
        <input type="text" id="register-username-input" data-translate-key-placeholder="register_username_placeholder" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙŠÙˆØ²Ø±)">

        <input type="text" id="register-telegram-input" data-translate-key-placeholder="register_telegram_placeholder" placeholder="ID Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… (Ù…Ø«Ø§Ù„: 123456789)">
        <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: -0.5rem; margin-bottom: 1rem;" data-translate-key="register_telegram_note">
            <strong>Ù…Ù„Ø­ÙˆØ¸Ø© Ù‡Ø§Ù…Ø©:</strong> Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªØ±Ø³Ù„ <code style="color: var(--accent-color);">/start</code> 
            Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙˆØª <strong>[ÙŠØ¬Ø¨ ÙˆØ¶Ø¹ Ø§Ø³Ù… Ø§Ù„Ø¨ÙˆØª Ù‡Ù†Ø§]</strong> Ø£ÙˆÙ„Ø§Ù‹.
            <br>
            (Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù€ ID Ø§Ù„Ø®Ø§Øµ Ø¨ÙƒØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ /start Ø¥Ù„Ù‰ <code style="color: var(--accent-color);">@userinfobot</code>)
        </p>

        <input type="password" id="register-password-input" data-translate-key-placeholder="register_password_placeholder" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button id="register-button" class="primary-button" data-translate-key="register_button">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        
        <div class="plan-container">
            <div class="plan-box premium">
                <h3 class="plan-title" data-translate-key="premium_plan_title">âœ¨ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ù…Ù…ÙŠØ²Ø© (Ø§Ù„Ù…Ø¯ÙÙˆØ¹) âœ¨</h3>
                <ul class="plan-features">
                    <li class="feature-item enabled" data-translate-key="premium_plan_feat1">ğŸ‰ Ø±Ø³Ø§ÙŠÙ„ Ø·ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø± ğŸ¥³</li>
                    <li class="feature-item enabled" data-translate-key="premium_plan_feat2">âœ… ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©</li>
                    <li class="feature-item enabled" data-translate-key="premium_plan_feat3">âœ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ø© Ø£ÙˆÙ„ (VIP)</li>
                    <li class="feature-item enabled" data-translate-key="premium_plan_feat4">âœ… Ù†Ø¸Ø§Ù… Ù…Ø­Ø³Ù‘Ù† ÙˆÙ…ØªØ·ÙˆØ±</li>
                </ul>
            </div>
            <div class="plan-box free">
                <h3 class="plan-title" data-translate-key="free_plan_title">ğŸ‘‹ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© ğŸ‘‹</h3>
                <ul class="plan-features">
                    <li class="feature-item disabled" data-translate-key="free_plan_feat1">âŒ Ø±Ø³Ø§Ø¦Ù„ Ù…Ø­Ø¯ÙˆØ¯Ø© (10 ÙŠÙˆÙ…ÙŠØ§Ù‹)</li>
                    <li class="feature-item disabled" data-translate-key="free_plan_feat2">âŒ Ù†Ø¸Ø§Ù… Ø·Ø§Ø¨ÙˆØ± Ø·Ù„Ø¨Ø§Øª Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ù…Ø¬Ø§Ù†ÙŠÙŠÙ†</li>
                    <li class="feature-item enabled" data-translate-key="free_plan_feat3">âœ… Ù†Ø¸Ø§Ù… Ù…Ø­Ø³Ù‘Ù† ÙˆÙ…ØªØ·ÙˆØ±</li>
                </ul>
            </div>
        </div>
        
        <button id="show-login-btn" class="auth-switch-link" data-translate-key="have_account_link">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
    
    <div id="verify-wrapper" class="auth-card">
        <i class="fas fa-key icon"></i>
        <h2 data-translate-key="verify_title">Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨</h2>
        <p id="verify-message">Ø£Ø±Ø³Ù„Ù†Ø§ Ø±Ù…Ø² ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ ØªÙ„ÙŠØ¬Ø±Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„Ù‡.</p>
        <input type="text" id="verify-code-input" data-translate-key-placeholder="verify_code_placeholder" placeholder="Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ (6 Ø£Ø±Ù‚Ø§Ù…)">
        <button id="verify-button" class="primary-button" data-translate-key="verify_button">ØªØ­Ù‚Ù‚</button>
        <button id="show-login-btn-from-verify" class="auth-switch-link" data-translate-key="back_to_login_link">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
    
    <div id="forgot-wrapper" class="auth-card">
        <i class="fas fa-lock-open icon"></i>
        <h2 data-translate-key="forgot_title">Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
        <p data-translate-key="forgot_subtitle">Ø³ÙˆÙ Ù†Ø±Ø³Ù„ Ø±Ù…Ø² Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ ØªÙ„ÙŠØ¬Ø±Ø§Ù….</p>
        <input type="text" id="forgot-telegram-input" data-translate-key-placeholder="forgot_telegram_placeholder" placeholder="ID Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ">
        <button id="forgot-button" class="primary-button" data-translate-key="forgot_button">Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
        <button id="show-login-btn-from-forgot" class="auth-switch-link" data-translate-key="back_to_login_link">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div id="reset-code-wrapper" class="auth-card">
        <i class="fas fa-shield-alt icon"></i>
        <h2 data-translate-key="reset_code_title">Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</h2>
        <p id="reset-code-message">Ø£Ø±Ø³Ù„Ù†Ø§ Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¥Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„Ù‡.</p>
        <input type="text" id="reset-code-input" data-translate-key-placeholder="reset_code_placeholder" placeholder="Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© (6 Ø£Ø±Ù‚Ø§Ù…)">
        <button id="reset-code-button" class="primary-button" data-translate-key="reset_code_button">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù…Ø²</button>
        <button id="show-login-btn-from-reset" class="auth-switch-link" data-translate-key="back_to_login_link">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
    <div id="new-password-wrapper" class="auth-card">
        <i class="fas fa-key icon"></i>
        <h2 data-translate-key="new_password_title">ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <p data-translate-key="new_password_subtitle">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø­Ø³Ø§Ø¨Ùƒ.</p>
        <input type="password" id="new-password-input" data-translate-key-placeholder="new_password_placeholder" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
        <input type="password" id="confirm-password-input" data-translate-key-placeholder="confirm_password_placeholder" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
        <button id="new-password-button" class="primary-button" data-translate-key="new_password_button">Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
        <button id="show-login-btn-from-new-pass" class="auth-switch-link" data-translate-key="back_to_login_link">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
    <div id="promo-wrapper" class="auth-card">
        <i class="fab fa-telegram icon"></i>
        <h2 data-translate-key="promo_title">Ø§Ù†Ø¶Ù… Ø¥Ù„ÙŠÙ†Ø§</h2>
        <p data-translate-key="promo_subtitle">Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ† ÙˆØ§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø­ØµØ±ÙŠØ©</p>
        
        <div class="contact-list">
            <div class="contact-item">
                <i class="fas fa-code"></i>
                <span data-translate-key="promo_dev">Ø§Ù„Ø·ÙˆØ±: @BlackXV2</span>
            </div>
            <div class="contact-item">
                <i class="fas fa-user-secret"></i>
                <span data-translate-key="promo_alt">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ: @R3XVIP</span>
            </div>
        </div>
        
        <a href="https://t.me/BlackXV2VIP" target="_blank" id="join-telegram-btn" class="primary-button">
            <i class="fab fa-telegram"></i> <span data-translate-key="promo_join_button">Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù‚Ù†Ø§Ø©</span>
        </a>
        <button id="skip-promo-btn" class="secondary-button" data-translate-key="promo_skip_button">Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</button>
    </div>


    <main id="chat-wrapper" class="screen-container">
        <div id="chat-container">
            <header class="chat-header">
                <button id="new-chat-button" class="header-button" data-translate-key-title="new_chat_tooltip" title="Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©">
                    <i class="fas fa-plus"></i>
                    <span data-translate-key="new_chat_button">Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
                </button>
                <h1 id="title">WormGPT</h1>
                <button id="menu-button" class="header-button" data-translate-key-title="menu_tooltip" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
                    <i class="fas fa-bars"></i>
                </button>
            </header>
            
            <div id="chat-box">
                <div id="welcome-message">
                    <i class="fas fa-skull-crossbones"></i>
                    <h2 data-translate-key="welcome_title">WormGPT ğŸ˜ˆ</h2>
                </div>
            </div>
            
            <form id="input-area">
                <button type="button" id="mic-button" class="input-btn" data-translate-key-title="mic_tooltip" title="Ø¥Ø¯Ø®Ø§Ù„ ØµÙˆØªÙŠ" aria-label="Ø¥Ø¯Ø®Ø§Ù„ ØµÙˆØªÙŠ">
                    <i class="fas fa-microphone"></i>
                </button>
                <textarea id="message-input" data-translate-key-placeholder="message_placeholder" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." rows="1"></textarea>
                <button type="submit" id="send-button" class="input-btn" data-translate-key-aria-label="send_tooltip" aria-label="Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </main>

    <nav id="sidebar">
        <div class="sidebar-header" id="sidebar-username">
            Ø§Ù„Ø­Ø³Ø§Ø¨
        </div>
        <div class="sidebar-content" id="sidebar-chat-list">
            </div>
        <div class="sidebar-footer">
            <button id="logout-button">
                <i class="fas fa-sign-out-alt"></i>
                <span data-translate-key="logout_button">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>
    </nav>
    
    <div id="sidebar-overlay"></div>
    <div id="toast-container"></div>

    <script>
        (function() {
            'use strict';

            // =================================================================== //
            //                      0. TRANSLATION & I18N                         //
            // =================================================================== //
            const translations = {
                'en': {
                    'login_title': 'WormGPT ğŸ˜ˆ', 'login_subtitle': 'Login to continue', 'login_username_placeholder': 'Username', 'login_password_placeholder': 'Password', 'login_button': 'Login', 'forgot_password_link': 'Forgot password?', 'no_account_link': 'No account? Create one',
                    'register_title': 'Create New Account', 'register_subtitle': 'Please fill all fields', 'register_name_placeholder': 'Name (e.g., R3X)', 'register_username_placeholder': 'Username', 'register_telegram_placeholder': 'Telegram ID (e.g., 123456789)', 'register_telegram_note': '<strong>Important Note:</strong> To receive the code, you must first send <code>/start</code> to the bot <strong>[Bot name here]</strong>.<br>(To get your ID, send /start to <code>@userinfobot</code>)', 'register_password_placeholder': 'Password', 'register_button': 'Create Account',
                    'premium_plan_title': 'âœ¨ Premium Plan âœ¨', 'premium_plan_feat1': 'ğŸ‰ Messages all month long ğŸ¥³', 'premium_plan_feat2': 'âœ… Unlimited', 'premium_plan_feat3': 'âœ… Priority Access (VIP)', 'premium_plan_feat4': 'âœ… Enhanced & Advanced System',
                    'free_plan_title': 'ğŸ‘‹ Free Plan ğŸ‘‹', 'free_plan_feat1': 'âŒ Limited messages (10 per day)', 'free_plan_feat2': 'âŒ Queue system for free users', 'free_plan_feat3': 'âœ… Enhanced & Advanced System',
                    'have_account_link': 'Already have an account? Login',
                    'verify_title': 'Verify Account', 'verify_message': 'We sent a verification code to your Telegram account ({telegramId}). Please enter it.', 'verify_code_placeholder': 'Verification Code (6 digits)', 'verify_button': 'Verify', 'back_to_login_link': 'Back to Login',
                    'forgot_title': 'Reset Password', 'forgot_subtitle': 'We will send a recovery code to your Telegram account.', 'forgot_telegram_placeholder': 'Your Telegram Account ID', 'forgot_button': 'Send Recovery Code',
                    'reset_code_title': 'Enter Recovery Code', 'reset_code_message': 'We sent a recovery code to Telegram. Please enter it.', 'reset_code_placeholder': 'Recovery Code (6 digits)', 'reset_code_button': 'Confirm Code',
                    'new_password_title': 'Set New Password', 'new_password_subtitle': 'Please enter the new password for your account.', 'new_password_placeholder': 'New Password', 'confirm_password_placeholder': 'Confirm New Password', 'new_password_button': 'Save Password',
                    'promo_title': 'Join Us', 'promo_subtitle': 'For developers and more exclusive updates', 'promo_dev': 'Developer: @BlackXV2', 'promo_alt': 'Second Account: @R3XVIP', 'promo_join_button': 'Join Channel', 'promo_skip_button': 'Continue to Chat',
                    'new_chat_tooltip': 'New Chat', 'new_chat_button': 'New Chat', 'menu_tooltip': 'Menu', 'welcome_title': 'WormGPT ğŸ˜ˆ', 'mic_tooltip': 'Voice Input', 'message_placeholder': 'Type your message here...', 'send_tooltip': 'Send Message',
                    'sidebar_header_default': 'Account', 'sidebar_welcome_user': 'Welcome, {username}', 'no_chats_message': 'No previous chats.',
                    'logout_button': 'Logout', 'logout_confirm': 'Are you sure you want to log out?',
                    'copy_code_button': 'Copy Code',
                    'action_copy_tooltip': 'Copy', 'action_dislike_tooltip': 'Dislike', 'action_like_tooltip': 'Like', 'action_regenerate_tooltip': 'Regenerate', 'action_save_image_tooltip': 'Save as Image',
                    'toast_fill_fields': 'Please fill all fields', 'toast_user_not_found': 'Username not found', 'toast_wrong_password': 'Incorrect password', 'toast_account_unverified': 'This account is not verified. Resending code.',
                    'toast_sending_code': 'Sending code...', 'toast_telegram_id_numeric': 'Telegram ID must be numbers only', 'toast_user_exists': 'This username already exists', 'toast_code_sent': 'Code sent. Please verify your account.',
                    'toast_enter_code': 'Please enter the verification code', 'toast_session_expired': 'Error: Verification session expired. Please log in again.', 'toast_verified_success': 'Successfully verified! You can now log in.', 'toast_wrong_code': 'Incorrect verification code',
                    'toast_invalid_telegram_id': 'Please enter a valid Telegram ID (numbers only)', 'toast_id_not_registered': 'This Telegram ID is not registered', 'toast_reset_code_sent': 'Recovery code sent to Telegram!', 'toast_reset_fail': 'Failed to send code. Please try again.',
                    'toast_enter_reset_code': 'Please enter the recovery code', 'toast_reset_session_expired': 'Error: Recovery session expired. Please request a new code.', 'toast_reset_code_ok': 'Code is correct. Please set a new password.', 'toast_wrong_reset_code': 'Incorrect recovery code',
                    'toast_passwords_no_match': 'Passwords do not match', 'toast_password_too_short': 'Password is too short (min 4 characters)', 'toast_password_changed': 'Password changed successfully! You can now log in.',
                    'toast_unverified_account_error': 'Error: This account has not been verified.', 'limit_reached': 'You have reached the daily limit of {limit} free messages.', 'toast_new_chat': 'Started a new chat',
                    'toast_delete_chat_confirm': 'Are you sure you want to delete this chat? This action cannot be undone.', 'toast_chat_deleted': 'Chat deleted', 'toast_generating_image': 'Generating image...', 'toast_image_save_error': 'Failed to save image',
                    'toast_answer_copied': 'Answer copied!', 'toast_code_copied': 'Code copied!', 'toast_voice_unsupported': 'Your browser does not support voice recognition.', 'toast_voice_error': 'Voice recognition error',
                    'new_chat_title': 'New Chat'
                },
                'es': {
                    'login_title': 'WormGPT ğŸ˜ˆ', 'login_subtitle': 'Inicia sesiÃ³n para continuar', 'login_username_placeholder': 'Usuario', 'login_password_placeholder': 'ContraseÃ±a', 'login_button': 'Iniciar SesiÃ³n', 'forgot_password_link': 'Â¿Olvidaste la contraseÃ±a?', 'no_account_link': 'Â¿No tienes cuenta? Crea una',
                    'register_title': 'Crear Cuenta Nueva', 'register_subtitle': 'Por favor, rellena todos los campos', 'register_name_placeholder': 'Nombre (ej: R3X)', 'register_username_placeholder': 'Nombre de usuario', 'register_telegram_placeholder': 'ID de Telegram (ej: 123456789)', 'register_telegram_note': '<strong>Nota Importante:</strong> Para recibir el cÃ³digo, primero debes enviar <code>/start</code> al bot <strong>[Nombre del bot aquÃ­]</strong>.<br>(Para obtener tu ID, envÃ­a /start a <code>@userinfobot</code>)', 'register_password_placeholder': 'ContraseÃ±a', 'register_button': 'Crear Cuenta',
                    'premium_plan_title': 'âœ¨ Plan Premium âœ¨', 'premium_plan_feat1': 'ğŸ‰ Mensajes todo el mes ğŸ¥³', 'premium_plan_feat2': 'âœ… Ilimitados', 'premium_plan_feat3': 'âœ… Acceso Prioritario (VIP)', 'premium_plan_feat4': 'âœ… Sistema Mejorado y Avanzado',
                    'free_plan_title': 'ğŸ‘‹ Plan Gratuito ğŸ‘‹', 'free_plan_feat1': 'âŒ Mensajes limitados (10 por dÃ­a)', 'free_plan_feat2': 'âŒ Sistema de cola para usuarios gratuitos', 'free_plan_feat3': 'âœ… Sistema Mejorado y Avanzado',
                    'have_account_link': 'Â¿Ya tienes una cuenta? Inicia sesiÃ³n',
                    'verify_title': 'Verificar Cuenta', 'verify_message': 'Enviamos un cÃ³digo de verificaciÃ³n a tu cuenta de Telegram ({telegramId}). Por favor, ingrÃ©salo.', 'verify_code_placeholder': 'CÃ³digo de VerificaciÃ³n (6 dÃ­gitos)', 'verify_button': 'Verificar', 'back_to_login_link': 'Volver a Iniciar SesiÃ³n',
                    'forgot_title': 'Restablecer ContraseÃ±a', 'forgot_subtitle': 'Enviaremos un cÃ³digo de recuperaciÃ³n a tu cuenta de Telegram.', 'forgot_telegram_placeholder': 'ID de tu cuenta de Telegram', 'forgot_button': 'Enviar CÃ³digo de RecuperaciÃ³n',
                    'reset_code_title': 'Ingresar CÃ³digo de RecuperaciÃ³n', 'reset_code_message': 'Enviamos un cÃ³digo de recuperaciÃ³n a Telegram. Por favor, ingrÃ©salo.', 'reset_code_placeholder': 'CÃ³digo de RecuperaciÃ³n (6 dÃ­gitos)', 'reset_code_button': 'Confirmar CÃ³digo',
                    'new_password_title': 'Establecer Nueva ContraseÃ±a', 'new_password_subtitle': 'Por favor, ingresa la nueva contraseÃ±a para tu cuenta.', 'new_password_placeholder': 'Nueva ContraseÃ±a', 'confirm_password_placeholder': 'Confirmar Nueva ContraseÃ±a', 'new_password_button': 'Guardar ContraseÃ±a',
                    'promo_title': 'Ãšnete a Nosotros', 'promo_subtitle': 'Para desarrolladores y mÃ¡s actualizaciones exclusivas', 'promo_dev': 'Desarrollador: @BlackXV2', 'promo_alt': 'Segunda Cuenta: @R3XVIP', 'promo_join_button': 'Unirse al Canal', 'promo_skip_button': 'Continuar al Chat',
                    'new_chat_tooltip': 'Nuevo Chat', 'new_chat_button': 'Nuevo Chat', 'menu_tooltip': 'MenÃº', 'welcome_title': 'WormGPT ğŸ˜ˆ', 'mic_tooltip': 'Entrada de Voz', 'message_placeholder': 'Escribe tu mensaje aquÃ­...', 'send_tooltip': 'Enviar Mensaje',
                    'sidebar_header_default': 'Cuenta', 'sidebar_welcome_user': 'Bienvenido, {username}', 'no_chats_message': 'No hay chats anteriores.',
                    'logout_button': 'Cerrar SesiÃ³n', 'logout_confirm': 'Â¿EstÃ¡s seguro de que quieres cerrar sesiÃ³n?',
                    'copy_code_button': 'Copiar CÃ³digo',
                    'action_copy_tooltip': 'Copiar', 'action_dislike_tooltip': 'No me gusta', 'action_like_tooltip': 'Me gusta', 'action_regenerate_tooltip': 'Regenerar', 'action_save_image_tooltip': 'Guardar como Imagen',
                    'toast_fill_fields': 'Por favor, rellena todos los campos', 'toast_user_not_found': 'Usuario no encontrado', 'toast_wrong_password': 'ContraseÃ±a incorrecta', 'toast_account_unverified': 'Esta cuenta no estÃ¡ verificada. Reenviando cÃ³digo.',
                    'toast_sending_code': 'Enviando cÃ³digo...', 'toast_telegram_id_numeric': 'El ID de Telegram debe ser solo nÃºmeros', 'toast_user_exists': 'Este nombre de usuario ya existe', 'toast_code_sent': 'CÃ³digo enviado. Por favor, verifica tu cuenta.',
                    'toast_enter_code': 'Por favor, introduce el cÃ³digo de verificaciÃ³n', 'toast_session_expired': 'Error: La sesiÃ³n de verificaciÃ³n ha expirado. Por favor, inicia sesiÃ³n de nuevo.', 'toast_verified_success': 'Â¡Verificado con Ã©xito! Ahora puedes iniciar sesiÃ³n.', 'toast_wrong_code': 'CÃ³digo de verificaciÃ³n incorrecto',
                    'toast_invalid_telegram_id': 'Por favor, introduce un ID de Telegram vÃ¡lido (solo nÃºmeros)', 'toast_id_not_registered': 'Este ID de Telegram no estÃ¡ registrado', 'toast_reset_code_sent': 'Â¡CÃ³digo de recuperaciÃ³n enviado a Telegram!', 'toast_reset_fail': 'Error al enviar el cÃ³digo. IntÃ©ntalo de nuevo.',
                    'toast_enter_reset_code': 'Por favor, introduce el cÃ³digo de recuperaciÃ³n', 'toast_reset_session_expired': 'Error: La sesiÃ³n de recuperaciÃ³n ha expirado. Por favor, solicita un nuevo cÃ³digo.', 'toast_reset_code_ok': 'CÃ³digo correcto. Por favor, establece una nueva contraseÃ±a.', 'toast_wrong_reset_code': 'CÃ³digo de recuperaciÃ³n incorrecto',
                    'toast_passwords_no_match': 'Las contraseÃ±as no coinciden', 'toast_password_too_short': 'La contraseÃ±a es demasiado corta (mÃ­n. 4 caracteres)', 'toast_password_changed': 'Â¡ContraseÃ±a cambiada con Ã©xito! Ahora puedes iniciar sesiÃ³n.',
                    'toast_unverified_account_error': 'Error: Esta cuenta no ha sido verificada.', 'limit_reached': 'Has alcanzado el lÃ­mite diario de {limit} mensajes gratuitos.', 'toast_new_chat': 'Nuevo chat iniciado',
                    'toast_delete_chat_confirm': 'Â¿EstÃ¡s seguro de que quieres eliminar este chat? Esta acciÃ³n no se puede deshacer.', 'toast_chat_deleted': 'Chat eliminado', 'toast_generating_image': 'Generando imagen...', 'toast_image_save_error': 'Error al guardar la imagen',
                    'toast_answer_copied': 'Â¡Respuesta copiada!', 'toast_code_copied': 'Â¡CÃ³digo copiado!', 'toast_voice_unsupported': 'Tu navegador no soporta el reconocimiento de voz.', 'toast_voice_error': 'Error en el reconocimiento de voz',
                    'new_chat_title': 'Nuevo Chat'
                },
                'ar': {
                    'login_title': 'WormGPT ğŸ˜ˆ', 'login_subtitle': 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©', 'login_username_placeholder': 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙŠÙˆØ²Ø±)', 'login_password_placeholder': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'login_button': 'Ø¯Ø®ÙˆÙ„', 'forgot_password_link': 'Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ', 'no_account_link': 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯',
                    'register_title': 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯', 'register_subtitle': 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'register_name_placeholder': 'Ø§Ù„Ø§Ø³Ù… (Ù…Ø«Ø§Ù„: R3X)', 'register_username_placeholder': 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙŠÙˆØ²Ø±)', 'register_telegram_placeholder': 'ID Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… (Ù…Ø«Ø§Ù„: 123456789)', 'register_telegram_note': '<strong>Ù…Ù„Ø­ÙˆØ¸Ø© Ù‡Ø§Ù…Ø©:</strong> Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªØ±Ø³Ù„ <code style="color: var(--accent-color);">/start</code> Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙˆØª <strong>[ÙŠØ¬Ø¨ ÙˆØ¶Ø¹ Ø§Ø³Ù… Ø§Ù„Ø¨ÙˆØª Ù‡Ù†Ø§]</strong> Ø£ÙˆÙ„Ø§Ù‹.<br>(Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù€ ID Ø§Ù„Ø®Ø§Øµ Ø¨ÙƒØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ /start Ø¥Ù„Ù‰ <code style="color: var(--accent-color);">@userinfobot</code>)', 'register_password_placeholder': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'register_button': 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨',
                    'premium_plan_title': 'âœ¨ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ù…Ù…ÙŠØ²Ø© (Ø§Ù„Ù…Ø¯ÙÙˆØ¹) âœ¨', 'premium_plan_feat1': 'ğŸ‰ Ø±Ø³Ø§ÙŠÙ„ Ø·ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø± ğŸ¥³', 'premium_plan_feat2': 'âœ… ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©', 'premium_plan_feat3': 'âœ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ø© Ø£ÙˆÙ„ (VIP)', 'premium_plan_feat4': 'âœ… Ù†Ø¸Ø§Ù… Ù…Ø­Ø³Ù‘Ù† ÙˆÙ…ØªØ·ÙˆØ±',
                    'free_plan_title': 'ğŸ‘‹ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© ğŸ‘‹', 'free_plan_feat1': 'âŒ Ø±Ø³Ø§Ø¦Ù„ Ù…Ø­Ø¯ÙˆØ¯Ø© (10 ÙŠÙˆÙ…ÙŠØ§Ù‹)', 'free_plan_feat2': 'âŒ Ù†Ø¸Ø§Ù… Ø·Ø§Ø¨ÙˆØ± Ø·Ù„Ø¨Ø§Øª Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ù…Ø¬Ø§Ù†ÙŠÙŠÙ†', 'free_plan_feat3': 'âœ… Ù†Ø¸Ø§Ù… Ù…Ø­Ø³Ù‘Ù† ÙˆÙ…ØªØ·ÙˆØ±',
                    'have_account_link': 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
                    'verify_title': 'Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨', 'verify_message': 'Ø£Ø±Ø³Ù„Ù†Ø§ Ø±Ù…Ø² ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ ({telegramId}) ÙÙŠ ØªÙ„ÙŠØ¬Ø±Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„Ù‡.', 'verify_code_placeholder': 'Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ (6 Ø£Ø±Ù‚Ø§Ù…)', 'verify_button': 'ØªØ­Ù‚Ù‚', 'back_to_login_link': 'Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
                    'forgot_title': 'Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'forgot_subtitle': 'Ø³ÙˆÙ Ù†Ø±Ø³Ù„ Ø±Ù…Ø² Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ ØªÙ„ÙŠØ¬Ø±Ø§Ù….', 'forgot_telegram_placeholder': 'ID Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ', 'forgot_button': 'Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
                    'reset_code_title': 'Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©', 'reset_code_message': 'Ø£Ø±Ø³Ù„Ù†Ø§ Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¥Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„Ù‡.', 'reset_code_placeholder': 'Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© (6 Ø£Ø±Ù‚Ø§Ù…)', 'reset_code_button': 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù…Ø²',
                    'new_password_title': 'ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©', 'new_password_subtitle': 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø­Ø³Ø§Ø¨Ùƒ.', 'new_password_placeholder': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', 'confirm_password_placeholder': 'ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', 'new_password_button': 'Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
                    'promo_title': 'Ø§Ù†Ø¶Ù… Ø¥Ù„ÙŠÙ†Ø§', 'promo_subtitle': 'Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ† ÙˆØ§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø­ØµØ±ÙŠØ©', 'promo_dev': 'Ø§Ù„Ø·ÙˆØ±: @BlackXV2', 'promo_alt': 'Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ: @R3XVIP', 'promo_join_button': 'Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù‚Ù†Ø§Ø©', 'promo_skip_button': 'Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©',
                    'new_chat_tooltip': 'Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©', 'new_chat_button': 'Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©', 'menu_tooltip': 'Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'welcome_title': 'WormGPT ğŸ˜ˆ', 'mic_tooltip': 'Ø¥Ø¯Ø®Ø§Ù„ ØµÙˆØªÙŠ', 'message_placeholder': 'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...', 'send_tooltip': 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©',
                    'sidebar_header_default': 'Ø§Ù„Ø­Ø³Ø§Ø¨', 'sidebar_welcome_user': 'Ø£Ù‡Ù„Ø§Ù‹ØŒ {username}', 'no_chats_message': 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø³Ø§Ø¨Ù‚Ø©.',
                    'logout_button': 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'logout_confirm': 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ',
                    'copy_code_button': 'Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯',
                    'action_copy_tooltip': 'Ù†Ø³Ø®', 'action_dislike_tooltip': 'Ù„Ø§ ÙŠØ¹Ø¬Ø¨Ù†ÙŠ', 'action_like_tooltip': 'ÙŠØ¹Ø¬Ø¨Ù†ÙŠ', 'action_regenerate_tooltip': 'Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡', 'action_save_image_tooltip': 'Ø­ÙØ¸ ÙƒØµÙˆØ±Ø©',
                    'toast_fill_fields': 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'toast_user_not_found': 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ­ÙŠØ­', 'toast_wrong_password': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'toast_account_unverified': 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙØ¹Ù„. Ø³Ù†Ø¹ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø².',
                    'toast_sending_code': 'Ø¬Ø§Ø±Ù Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²...', 'toast_telegram_id_numeric': 'ID Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ø±Ù‚Ø§Ù…Ø§Ù‹ ÙÙ‚Ø·', 'toast_user_exists': 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„', 'toast_code_sent': 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø². ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø³Ø§Ø¨Ùƒ.',
                    'toast_enter_code': 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚', 'toast_session_expired': 'Ø®Ø·Ø£: Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†ØªÙ‡ÙŠØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„.', 'toast_verified_success': 'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.', 'toast_wrong_code': 'Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­',
                    'toast_invalid_telegram_id': 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ID ØªÙ„ÙŠØ¬Ø±Ø§Ù… ØµØ­ÙŠØ­ (Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)', 'toast_id_not_registered': 'ID Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù‡Ø°Ø§ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ù„Ø¯ÙŠÙ†Ø§', 'toast_reset_code_sent': 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¥Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù…!', 'toast_reset_fail': 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø². Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.',
                    'toast_enter_reset_code': 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©', 'toast_reset_session_expired': 'Ø®Ø·Ø£: Ø¬Ù„Ø³Ø© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù†ØªÙ‡ÙŠØ©. Ø§Ø·Ù„Ø¨ Ø§Ù„Ø±Ù…Ø² Ù…Ø¬Ø¯Ø¯Ø§Ù‹.', 'toast_reset_code_ok': 'Ø§Ù„Ø±Ù…Ø² ØµØ­ÙŠØ­. ØªÙØ¶Ù„ Ø¨ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©.', 'toast_wrong_reset_code': 'Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© ØºÙŠØ± ØµØ­ÙŠØ­',
                    'toast_passwords_no_match': 'ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†', 'toast_password_too_short': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ (4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)', 'toast_password_changed': 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.',
                    'toast_unverified_account_error': 'Ø®Ø·Ø£: Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡.', 'limit_reached': 'Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ ({limit}) Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Ø§Ù„ÙŠÙˆÙ…', 'toast_new_chat': 'ØªÙ… Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©',
                    'toast_delete_chat_confirm': 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.', 'toast_chat_deleted': 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©', 'toast_generating_image': 'Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø©...', 'toast_image_save_error': 'ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©',
                    'toast_answer_copied': 'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©!', 'toast_code_copied': 'ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯!', 'toast_voice_unsupported': 'Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª.', 'toast_voice_error': 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª',
                    'new_chat_title': 'Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©'
                }
            };
            let currentLang = 'ar'; // Default

            function translate(key, replacements = {}) {
                let text = translations[currentLang]?.[key] || key;
                for (const placeholder in replacements) {
                    text = text.replace(`{${placeholder}}`, replacements[placeholder]);
                }
                return text;
            }

            function detectAndApplyLanguage() {
                const browserLang = (navigator.language || navigator.userLanguage).split('-')[0];
                if (['en', 'es'].includes(browserLang)) {
                    currentLang = browserLang;
                } else {
                    currentLang = 'ar'; // Default to Arabic
                }

                document.documentElement.lang = currentLang;
                document.documentElement.dir = (currentLang === 'ar') ? 'rtl' : 'ltr';

                document.querySelectorAll('[data-translate-key]').forEach(el => { el.innerHTML = translate(el.dataset.translateKey); });
                document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => { el.placeholder = translate(el.dataset.translateKeyPlaceholder); });
                document.querySelectorAll('[data-translate-key-title]').forEach(el => { el.title = translate(el.dataset.translateKeyTitle); });
                document.querySelectorAll('[data-translate-key-aria-label]').forEach(el => { el.setAttribute('aria-label', translate(el.dataset.translateKeyAriaLabel)); });
            }

            // =================================================================== //
            //                      1. INITIALIZATION & STATE                      //
            // =================================================================== //
            
            const DEFAULT_CONFIG = {
                API_URL: "https://yojagahyhoogwtfpvtok.supabase.co/functions/v1/chat",
                API_KEY: "wgpt_a9a48e5xh95hujecpbpmdv", 
                BOT_TOKEN: "8065976642:AAGjVtQv31YDa1RbEDGx6AtkQK68PwZUo1c"
            };

            let CONFIG = { ...DEFAULT_CONFIG };
            const DOM = {};
            let isProcessing = false;
            let isRecording = false;
            let recognition;
            
            let currentUser = null;
            let currentChatId = null;
            let chatList = []; 
            let conversationHistory = []; 
            let sessionId = null; 
            
            const USERS_DB_KEY = 'wormgpt-users';

            // =================================================================== //
            //                      2. DOM READY & SETUP                         //
            // =================================================================== //

            document.addEventListener('DOMContentLoaded', () => {
                detectAndApplyLanguage();

                const ids = [
                    'html', 'chat-wrapper', 'chat-container', 'chat-box', 'welcome-message', 
                    'input-area', 'message-input', 'send-button', 'new-chat-button', 
                    'mic-button', 'toast-container', 'title', 'sidebar', 
                    'sidebar-overlay', 'menu-button',
                    'auth-wrapper', 'login-username-input', 'login-password-input', 'login-button', 'show-register-btn',
                    'register-wrapper', 'register-name-input', 'register-username-input', 'register-telegram-input', 'register-password-input', 'register-button', 'show-login-btn',
                    'verify-wrapper', 'verify-message', 'verify-code-input', 'verify-button', 'show-login-btn-from-verify',
                    'forgot-wrapper', 'forgot-telegram-input', 'forgot-button', 'show-login-btn-from-forgot', 'show-forgot-btn',
                    'reset-code-wrapper', 'reset-code-message', 'reset-code-input', 'reset-code-button', 'show-login-btn-from-reset',
                    'new-password-wrapper', 'new-password-input', 'confirm-password-input', 'new-password-button', 'show-login-btn-from-new-pass',
                    'logout-button', 'sidebar-username',
                    'promo-wrapper', 'skip-promo-btn',
                    'sidebar-chat-list' 
                ];
                ids.forEach(id => DOM[id.replace(/-(\w)/g, (m, g) => g.toUpperCase())] = document.getElementById(id) || document.documentElement);

                loadConfig();
                initializeDefaultAdmin(); 
                setupEventListeners();
                setupActionButtonsListener(); 
                autoResizeTextarea();
                checkLoginState(); 
                
                DOM.sendButton.disabled = true;
                
                document.addEventListener('touchstart', function(e) {
                    if (e.touches.length > 1) e.preventDefault();
                }, { passive: false });
            });
            
            // =================================================================== //
            //                      3. EVENT LISTENERS                           //
            // =================================================================== //

            function setupEventListeners() {
                DOM.inputArea.addEventListener('submit', (e) => { e.preventDefault(); sendMessage(); });
                DOM.newChatButton.addEventListener('click', () => startNewChat(true)); 
                DOM.messageInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
                DOM.messageInput.addEventListener('input', () => { autoResizeTextarea(); DOM.sendButton.disabled = DOM.messageInput.value.trim() === ''; });
                DOM.micButton.addEventListener('click', toggleVoiceRecognition);
                DOM.menuButton.addEventListener('click', toggleSidebar);
                DOM.sidebarOverlay.addEventListener('click', closeSidebar);
                DOM.loginButton.addEventListener('click', loginUser);
                DOM.registerButton.addEventListener('click', registerUser);
                DOM.showRegisterBtn.addEventListener('click', () => showScreen('register'));
                DOM.showLoginBtn.addEventListener('click', () => showScreen('login'));
                DOM.logoutButton.addEventListener('click', logoutUser);
                DOM.loginUsernameInput.addEventListener('keydown', e => { if (e.key === 'Enter') loginUser(); });
                DOM.skipPromoBtn.addEventListener('click', skipPromo);
                DOM.verifyButton.addEventListener('click', verifyCode);
                DOM.showLoginBtnFromVerify.addEventListener('click', () => showScreen('login'));
                DOM.showForgotBtn.addEventListener('click', () => showScreen('forgot'));
                DOM.forgotButton.addEventListener('click', handleForgotPassword);
                DOM.showLoginBtnFromForgot.addEventListener('click', () => showScreen('login'));
                DOM.resetCodeButton.addEventListener('click', verifyResetCode);
                DOM.newPasswordButton.addEventListener('click', saveNewPassword);
                DOM.showLoginBtnFromReset.addEventListener('click', () => showScreen('login'));
                DOM.showLoginBtnFromNewPass.addEventListener('click', () => showScreen('login'));

                DOM.sidebarChatList.addEventListener('click', (e) => {
                    const chatLink = e.target.closest('.chat-list-item');
                    const deleteBtn = e.target.closest('.delete-chat-btn');
                    if (deleteBtn) { e.preventDefault(); e.stopPropagation(); const chatId = deleteBtn.dataset.chatId; deleteChat(chatId); } 
                    else if (chatLink && !chatLink.classList.contains('active')) { e.preventDefault(); switchChat(chatLink.dataset.chatId); }
                });
                DOM.messageInput.addEventListener('focus', () => { setTimeout(() => { document.documentElement.style.zoom = "1"; }, 100); });
            }

            function autoResizeTextarea() {
                const textarea = DOM.messageInput;
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            function loadConfig() {
                const savedConfig = localStorage.getItem('wormgpt-config');
                if (savedConfig) { try { CONFIG = { ...CONFIG, ...JSON.parse(savedConfig) }; } catch (e) { console.error('Error loading config:', e); } }
            }

            // =================================================================== //
            //                      4. AUTHENTICATION & ACCOUNTS               //
            // =================================================================== //
            
            function initializeDefaultAdmin() {
                try { console.log('Default admin initialization skipped.'); } 
                catch (e) { console.error("Failed to initialize admin user:", e); }
            }

            function showScreen(screenName) {
                ['authWrapper', 'registerWrapper', 'promoWrapper', 'chatWrapper', 'verifyWrapper', 'forgotWrapper', 'resetCodeWrapper', 'newPasswordWrapper'].forEach(wrapper => {
                    if (DOM[wrapper]) DOM[wrapper].style.display = 'none';
                });
                
                const screenMap = { 'login': 'authWrapper', 'register': 'registerWrapper', 'promo': 'promoWrapper', 'chat': 'chatWrapper', 'verify': 'verifyWrapper', 'forgot': 'forgotWrapper', 'resetCode': 'resetCodeWrapper', 'newPassword': 'newPasswordWrapper' };
                const wrapperKey = screenMap[screenName];

                if (wrapperKey && DOM[wrapperKey]) {
                    DOM[wrapperKey].style.display = (screenName === 'chat') ? 'flex' : 'block';
                    if (screenName === 'verify') {
                        const telegramId = localStorage.getItem('wormgpt-verifyingTelegram') || 'account';
                        DOM.verifyMessage.textContent = translate('verify_message', { telegramId: telegramId });
                    }
                }
            }
            
            function checkLoginState() {
                if (localStorage.getItem('wormgpt-resettingUser')) {
                    showScreen(localStorage.getItem('wormgpt-resetCodeVerified') ? 'newPassword' : 'resetCode');
                    return;
                }
                if (localStorage.getItem('wormgpt-verifyingUser')) { showScreen('verify'); return; }
                const user = localStorage.getItem('wormgpt-currentUser');
                if (user) { loadChatForUser(user); } else { showScreen('login'); }
            }
            
            async function sendTelegramMessage(chatId, messageText) {
                const apiUrl = `https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/sendMessage`;
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: chatId, text: messageText, parse_mode: 'Markdown' }) });
                    const data = await response.json();
                    if (data.ok) return true;
                    console.error("Telegram API Error:", data.description);
                    showToast(data.description, "error");
                    return false;
                } catch (error) {
                    console.error("Fetch Error:", error);
                    showToast("Telegram connection failed. Check your network.", "error");
                    return false;
                }
            }

            async function sendVerificationCode(chatId, username) {
                const code = Math.floor(100000 + Math.random() * 900000).toString();
                const message = `Your WormGPT verification code is: \`${code}\`\n\nAccount: ${username}`;
                const sent = await sendTelegramMessage(chatId, message);
                if (sent) {
                    localStorage.setItem('wormgpt-verifyingUser', username);
                    localStorage.setItem('wormgpt-verificationCode', code);
                    localStorage.setItem('wormgpt-verifyingTelegram', chatId);
                }
                return sent;
            }

            async function loginUser() {
                const username = DOM.loginUsernameInput.value.trim();
                const password = DOM.loginPasswordInput.value.trim();
                if (!username || !password) { showToast(translate('toast_fill_fields'), "error"); return; }
                const users = JSON.parse(localStorage.getItem(USERS_DB_KEY)) || [];
                const user = users.find(u => u.username === username);
                if (!user) { showToast(translate('toast_user_not_found'), "error"); return; }
                if (btoa(password) !== user.password) { showToast(translate('toast_wrong_password'), "error"); return; }
                
                if (user.verified === false) {
                    showToast(translate('toast_account_unverified'), "error");
                    DOM.loginButton.disabled = true;
                    DOM.loginButton.textContent = translate('toast_sending_code');
                    const codeSent = await sendVerificationCode(user.telegram, user.username);
                    DOM.loginButton.disabled = false;
                    DOM.loginButton.textContent = translate('login_button');
                    if (codeSent) showScreen('verify');
                    return;
                }
                localStorage.setItem('wormgpt-currentUser', user.username);
                currentUser = user.username;
                showScreen('promo');
            }
            
            async function registerUser() {
                const name = DOM.registerNameInput.value.trim();
                const username = DOM.registerUsernameInput.value.trim();
                const telegramId = DOM.registerTelegramInput.value.trim();
                const password = DOM.registerPasswordInput.value.trim();
                if (!name || !username || !telegramId || !password) { showToast(translate('toast_fill_fields'), "error"); return; }
                if (!/^\d+$/.test(telegramId)) { showToast(translate('toast_telegram_id_numeric'), "error"); return; }
                const users = JSON.parse(localStorage.getItem(USERS_DB_KEY)) || [];
                if (users.some(u => u.username === username)) { showToast(translate('toast_user_exists'), "error"); return; }
                
                DOM.registerButton.disabled = true;
                DOM.registerButton.innerHTML = translate('toast_sending_code') + ' ğŸš€';
                const codeSent = await sendVerificationCode(telegramId, username);
                if (codeSent) {
                    const newUser = { name, username, telegram: telegramId, password: btoa(password), plan: 'free', verified: false };
                    users.push(newUser);
                    localStorage.setItem(USERS_DB_KEY, JSON.stringify(users));
                    showToast(translate('toast_code_sent'));
                    showScreen('verify');
                }
                DOM.registerButton.disabled = false;
                DOM.registerButton.textContent = translate('register_button');
            }

            function verifyCode() {
                const code = DOM.verifyCodeInput.value.trim();
                const username = localStorage.getItem('wormgpt-verifyingUser');
                const storedCode = localStorage.getItem('wormgpt-verificationCode');
                if (!code) { showToast(translate('toast_enter_code'), "error"); return; }
                if (!username || !storedCode) { showToast(translate('toast_session_expired'), "error"); showScreen('login'); return; }
                if (code === storedCode) {
                    const users = JSON.parse(localStorage.getItem(USERS_DB_KEY)) || [];
                    const userIndex = users.findIndex(u => u.username === username);
                    if (userIndex !== -1) { users[userIndex].verified = true; localStorage.setItem(USERS_DB_KEY, JSON.stringify(users)); }
                    showToast(translate('toast_verified_success'));
                    localStorage.removeItem('wormgpt-verifyingUser');
                    localStorage.removeItem('wormgpt-verificationCode');
                    localStorage.removeItem('wormgpt-verifyingTelegram');
                    DOM.verifyCodeInput.value = '';
                    showScreen('login');
                } else { showToast(translate('toast_wrong_code'), "error"); }
            }

            async function handleForgotPassword() {
                const telegramId = DOM.forgotTelegramInput.value.trim();
                if (!telegramId || !/^\d+$/.test(telegramId)) { showToast(translate('toast_invalid_telegram_id'), "error"); return; }
                DOM.forgotButton.disabled = true;
                DOM.forgotButton.textContent = translate('toast_sending_code');
                const users = JSON.parse(localStorage.getItem(USERS_DB_KEY)) || [];
                const user = users.find(u => u.telegram === telegramId);
                if (!user) {
                    showToast(translate('toast_id_not_registered'), "error");
                    DOM.forgotButton.disabled = false;
                    DOM.forgotButton.textContent = translate('forgot_button');
                    return;
                }
                const code = Math.floor(100000 + Math.random() * 900000).toString();
                const message = `Hello ${user.username},\n\nYour password recovery code is: \`${code}\`\n\nDo not share this code.`;
                const sent = await sendTelegramMessage(user.telegram, message);
                if (sent) {
                    localStorage.setItem('wormgpt-resettingUser', user.username);
                    localStorage.setItem('wormgpt-resetCode', code);
                    localStorage.removeItem('wormgpt-resetCodeVerified');
                    showToast(translate('toast_reset_code_sent'));
                    DOM.forgotTelegramInput.value = '';
                    showScreen('resetCode');
                } else { showToast(translate('toast_reset_fail'), "error"); }
                DOM.forgotButton.disabled = false;
                DOM.forgotButton.textContent = translate('forgot_button');
            }
            
            function verifyResetCode() {
                const code = DOM.resetCodeInput.value.trim();
                const storedCode = localStorage.getItem('wormgpt-resetCode');
                const username = localStorage.getItem('wormgpt-resettingUser');
                if (!code) { showToast(translate('toast_enter_reset_code'), "error"); return; }
                if (!username || !storedCode) { showToast(translate('toast_reset_session_expired'), "error"); cleanUpResetStorage(); showScreen('forgot'); return; }
                if (code === storedCode) {
                    showToast(translate('toast_reset_code_ok'));
                    localStorage.setItem('wormgpt-resetCodeVerified', 'true');
                    localStorage.removeItem('wormgpt-resetCode');
                    DOM.resetCodeInput.value = '';
                    showScreen('newPassword');
                } else { showToast(translate('toast_wrong_reset_code'), "error"); }
            }

            function saveNewPassword() {
                const newPassword = DOM.newPasswordInput.value.trim();
                const confirmPassword = DOM.confirmPasswordInput.value.trim();
                const username = localStorage.getItem('wormgpt-resettingUser');
                const isVerified = localStorage.getItem('wormgpt-resetCodeVerified');
                if (!username || !isVerified) { cleanUpResetStorage(); showScreen('login'); return; }
                if (!newPassword || !confirmPassword) { showToast(translate('toast_fill_fields'), "error"); return; }
                if (newPassword !== confirmPassword) { showToast(translate('toast_passwords_no_match'), "error"); return; }
                if (newPassword.length < 4) { showToast(translate('toast_password_too_short'), "error"); return; }
                const users = JSON.parse(localStorage.getItem(USERS_DB_KEY)) || [];
                const userIndex = users.findIndex(u => u.username === username);
                if (userIndex === -1) { cleanUpResetStorage(); showScreen('login'); return; }
                users[userIndex].password = btoa(newPassword);
                localStorage.setItem(USERS_DB_KEY, JSON.stringify(users));
                showToast(translate('toast_password_changed'));
                cleanUpResetStorage();
                DOM.newPasswordInput.value = '';
                DOM.confirmPasswordInput.value = '';
                showScreen('login');
            }
            
            function cleanUpResetStorage() {
                 localStorage.removeItem('wormgpt-resettingUser');
                 localStorage.removeItem('wormgpt-resetCode');
                 localStorage.removeItem('wormgpt-resetCodeVerified');
            }
            
            function skipPromo() { loadChatForUser(currentUser); }

            function loadChatForUser(username) {
                currentUser = username;
                DOM.sidebarUsername.textContent = translate('sidebar_welcome_user', { username: currentUser });
                showScreen('chat');
                loadChatState();
            }

            function logoutUser() {
                if (confirm(translate('logout_confirm'))) {
                    localStorage.removeItem('wormgpt-currentUser');
                    localStorage.removeItem('wormgpt-verifyingUser');
                    localStorage.removeItem('wormgpt-verificationCode');
                    localStorage.removeItem('wormgpt-verifyingTelegram');
                    cleanUpResetStorage();
                    currentUser = null;
                    location.reload();
                }
            }

            // =================================================================== //
            //                      5. UI & DISPLAY FUNCTIONS                    //
            // =================================================================== //
            
            function toggleSidebar() { DOM.sidebar.classList.contains('open') ? closeSidebar() : openSidebar(); }
            
            function openSidebar() {
                DOM.sidebar.classList.add('open');
                DOM.sidebarOverlay.classList.add('open');
                const transformValue = (currentLang === 'ar') ? '-60px' : '60px';
                DOM.chatContainer.style.transform = `translateX(${transformValue})`;
            }

            function closeSidebar() {
                DOM.sidebar.classList.remove('open');
                DOM.sidebarOverlay.classList.remove('open');
                DOM.chatContainer.style.transform = 'translateX(0)';
            }

            function addMessage(sender, content, isTyping = false) {
                const role = (sender === 'user' || sender === 'assistant') ? sender : 'assistant';
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}-message`;
                
                if (isTyping) {
                    messageDiv.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
                } else {
                    messageDiv.innerHTML = processCodeBlocks(content);
                    if (role === 'assistant') {
                        const actionsContainer = document.createElement('div');
                        actionsContainer.className = 'message-actions';
                        actionsContainer.innerHTML = `
                            <button class="action-btn copy-btn" title="${translate('action_copy_tooltip')}" data-copy-text="${encodeURIComponent(content)}"><i class="fas fa-copy"></i></button>
                            <button class="action-btn" title="${translate('action_dislike_tooltip')}" disabled><i class="fas fa-thumbs-down"></i></button>
                            <button class="action-btn" title="${translate('action_like_tooltip')}" disabled><i class="fas fa-thumbs-up"></i></button>
                            <button class="action-btn regenerate-btn" title="${translate('action_regenerate_tooltip')}"><i class="fas fa-sync-alt"></i></button>
                            <button class="action-btn save-image-btn" title="${translate('action_save_image_tooltip')}"><i class="fas fa-camera"></i></button>`;
                        messageDiv.appendChild(actionsContainer);
                    }
                }
                DOM.chatBox.appendChild(messageDiv);
                DOM.chatBox.scrollTop = DOM.chatBox.scrollHeight;
                return messageDiv;
            }

            function processCodeBlocks(content) {
                const codeBlockRegex = /```(\w+)?\n?([\s\S]*?)```/g;
                return content.replace(codeBlockRegex, (match, lang, code) => {
                    const language = lang || 'text';
                    const highlightedCode = hljs.highlightAuto(code.trim()).value;
                    return `<div class="code-block-wrapper"><button class="copy-code-btn" data-code="${encodeURIComponent(code.trim())}"><i class="fas fa-copy"></i> ${translate('copy_code_button')}</button><pre><code class="hljs ${language}">${highlightedCode}</code></pre></div>`;
                });
            }

            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'}"></i> <span>${message}</span>`;
                DOM.toastContainer.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); }, 4000);
            }

            // =================================================================== //
            //                      6. MESSAGE & CHAT HANDLING
            // =================================================================== //

            async function sendMessage(messageOverride = null) {
                const users = JSON.parse(localStorage.getItem(USERS_DB_KEY)) || [];
                const user = users.find(u => u.username === currentUser);
                if (user && !user.verified) { showToast(translate('toast_unverified_account_error'), "error"); logoutUser(); return; }
                if (user && user.plan !== 'premium') {
                    const today = new Date().toISOString().split('T')[0];
                    const usageKey = getStorageKey('messageUsage');
                    let usage = JSON.parse(localStorage.getItem(usageKey)) || { count: 0, date: today };
                    if (usage.date !== today) { usage = { count: 0, date: today }; }
                    if (usage.count >= 10) { showToast(translate('limit_reached', { limit: 10 }), "error"); return; }
                    if (!messageOverride) { usage.count++; localStorage.setItem(usageKey, JSON.stringify(usage)); }
                }
                
                const message = messageOverride ?? DOM.messageInput.value.trim();
                if (!message || isProcessing) return;
                if (DOM.welcomeMessage.style.display !== 'none') DOM.welcomeMessage.style.display = 'none';
                if (!messageOverride) {
                    DOM.messageInput.value = '';
                    DOM.sendButton.disabled = true;
                    autoResizeTextarea();
                    addMessage('user', message);
                }
                
                const typingIndicator = addMessage('assistant', '', true);
                isProcessing = true;
                DOM.sendButton.disabled = true;
                DOM.sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                try {
                    if (!messageOverride && conversationHistory.length === 0) updateChatTitle(message);
                    if (!messageOverride) { conversationHistory.push({ "role": "user", "content": message }); saveHistory(); }

                    const response = await fetch(CONFIG.API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ api_key: CONFIG.API_KEY, message: message, session_id: sessionId }) });
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    
                    const data = await response.json();
                    typingIndicator.remove();
                    
                    let assistantResponse = data.response || data.answer || `Error: ${data.error}` || 'Sorry, I could not process your request.';
                    addMessage('assistant', assistantResponse);
                    
                    if (!data.error) {
                        conversationHistory.push({ "role": "assistant", "content": assistantResponse });
                        sessionId = data.session_id;
                        saveHistory();
                        saveSession();
                    } else if (!messageOverride) { conversationHistory.pop(); saveHistory(); }
                    
                } catch (error) {
                    if (!messageOverride && conversationHistory.length > 0) { conversationHistory.pop(); saveHistory(); }
                    console.error('Error:', error);
                    typingIndicator.remove();
                    addMessage('assistant', 'Sorry, a connection error occurred. Please check your internet and try again.');
                    showToast('Connection error', 'error');
                } finally {
                    isProcessing = false;
                    DOM.sendButton.disabled = DOM.messageInput.value.trim() === '';
                    DOM.sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                }
            }

            // =================================================================== //
            //                      7. CHAT MANAGEMENT FUNCTIONS
            // =================================================================== //

            function getStorageKey(key) { return `wormgpt-${key}_${currentUser}`; }
            function saveChatList() { localStorage.setItem(getStorageKey('chatList'), JSON.stringify(chatList)); }
            function saveHistory() { if (currentChatId) localStorage.setItem(getStorageKey(`chatHistory-${currentChatId}`), JSON.stringify(conversationHistory)); }
            function saveSession() { if (currentChatId) localStorage.setItem(getStorageKey(`session-${currentChatId}`), sessionId); }

            function loadChatState() {
                chatList = JSON.parse(localStorage.getItem(getStorageKey('chatList'))) || [];
                currentChatId = localStorage.getItem(getStorageKey('currentChatId'));
                
                if (!currentChatId || !chatList.find(chat => chat.id === currentChatId)) {
                    if (chatList.length === 0) { startNewChat(false); return; }
                    currentChatId = chatList[0].id;
                    localStorage.setItem(getStorageKey('currentChatId'), currentChatId);
                }
                
                conversationHistory = JSON.parse(localStorage.getItem(getStorageKey(`chatHistory-${currentChatId}`))) || [];
                sessionId = localStorage.getItem(getStorageKey(`session-${currentChatId}`)) || null;
                
                Array.from(DOM.chatBox.getElementsByClassName('message')).forEach(msg => msg.remove());
                if (conversationHistory.length > 0) {
                    DOM.welcomeMessage.style.display = 'none';
                    conversationHistory.forEach(message => addMessage(message.role, message.content));
                } else { DOM.welcomeMessage.style.display = 'flex'; }
                populateSidebar();
            }

            function startNewChat(showToastMsg = true) {
                currentChatId = `chat_${Date.now()}`;
                chatList.unshift({ id: currentChatId, title: translate('new_chat_title'), timestamp: Date.now() });
                saveChatList();
                localStorage.setItem(getStorageKey('currentChatId'), currentChatId);
                conversationHistory = [];
                sessionId = null;
                saveHistory();
                saveSession();
                loadChatState();
                if (showToastMsg) showToast(translate('toast_new_chat'));
            }
            
            function switchChat(chatId) {
                if (chatId === currentChatId) return;
                currentChatId = chatId;
                localStorage.setItem(getStorageKey('currentChatId'), currentChatId);
                loadChatState();
                closeSidebar();
            }
            
            function populateSidebar() {
                DOM.sidebarChatList.innerHTML = '';
                if (chatList.length === 0) {
                    DOM.sidebarChatList.innerHTML = `<p style="padding: 1rem; color: var(--text-secondary); text-align: center;">${translate('no_chats_message')}</p>`;
                    return;
                }
                chatList.forEach(chat => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'chat-list-item';
                    item.dataset.chatId = chat.id;
                    item.innerHTML = `<span class="chat-list-title">${chat.title}</span><button class="delete-chat-btn" data-chat-id="${chat.id}" title="Delete Chat"><i class="fas fa-trash-alt"></i></button>`;
                    if (chat.id === currentChatId) item.classList.add('active');
                    DOM.sidebarChatList.appendChild(item);
                });
            }
            
            function updateChatTitle(firstMessage) {
                const newTitle = firstMessage.substring(0, 30) + (firstMessage.length > 30 ? '...' : '');
                const chatIndex = chatList.findIndex(chat => chat.id === currentChatId);
                if (chatIndex !== -1) { chatList[chatIndex].title = newTitle; saveChatList(); populateSidebar(); }
            }
            
            function deleteChat(chatIdToDelete) {
                if (!confirm(translate('toast_delete_chat_confirm'))) return;
                chatList = chatList.filter(chat => chat.id !== chatIdToDelete);
                saveChatList();
                localStorage.removeItem(getStorageKey(`chatHistory-${chatIdToDelete}`));
                localStorage.removeItem(getStorageKey(`session-${chatIdToDelete}`));
                if (currentChatId === chatIdToDelete) { chatList.length > 0 ? switchChat(chatList[0].id) : startNewChat(false); } 
                else { populateSidebar(); }
                showToast(translate('toast_chat_deleted'));
            }
            
            // =================================================================== //
            //                      8. ACTION BUTTONS & UTILS
            // =================================================================== //

            function setupActionButtonsListener() {
                DOM.chatBox.addEventListener('click', async function(e) {
                    const button = e.target.closest('.action-btn');
                    if (!button) return;
                    e.preventDefault();
                    e.stopPropagation();
                    if (button.classList.contains('copy-btn')) copyToClipboard(decodeURIComponent(button.dataset.copyText));
                    if (button.classList.contains('regenerate-btn')) await regenerateResponse(button);
                    if (button.classList.contains('save-image-btn')) await saveMessageAsImage(button);
                });
            }
            
            async function regenerateResponse(button) {
                if (isProcessing) return;
                const lastUserMessage = conversationHistory.filter(m => m.role === 'user').pop();
                if (!lastUserMessage) return;
                if (conversationHistory[conversationHistory.length - 1].role === 'assistant') { conversationHistory.pop(); saveHistory(); }
                button.closest('.message').remove();
                await sendMessage(lastUserMessage.content);
            }
            
            async function saveMessageAsImage(button) {
                const messageToCapture = button.closest('.message');
                showToast(translate('toast_generating_image'));
                try {
                    const actions = messageToCapture.querySelector('.message-actions');
                    if (actions) actions.style.display = 'none';
                    const canvas = await html2canvas(messageToCapture, { backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--background-assistant-msg').trim(), useCORS: true, scale: 2 });
                    if (actions) actions.style.display = 'flex';
                    const link = document.createElement('a');
                    link.download = `wormgpt-capture-${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (err) {
                    console.error('Image save error:', err);
                    showToast(translate('toast_image_save_error'), 'error');
                    const actions = messageToCapture.querySelector('.message-actions');
                    if (actions) actions.style.display = 'flex';
                }
            }

            // =================================================================== //
            //                      9. VOICE RECOGNITION
            // =================================================================== //

            function toggleVoiceRecognition() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) { showToast(translate('toast_voice_unsupported'), 'error'); return; }
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = recognition || new SpeechRecognition();
                const langMap = { 'ar': 'ar-SA', 'en': 'en-US', 'es': 'es-ES' };
                recognition.lang = langMap[currentLang];
                recognition.continuous = false; recognition.interimResults = false;

                if (!isRecording) {
                    recognition.start();
                    DOM.micButton.classList.add('recording');
                    isRecording = true;
                    recognition.onresult = (event) => { DOM.messageInput.value = event.results[0][0].transcript; DOM.sendButton.disabled = false; autoResizeTextarea(); };
                    recognition.onerror = (event) => { console.error('Voice recognition error', event.error); showToast(translate('toast_voice_error'), 'error'); DOM.micButton.classList.remove('recording'); isRecording = false; };
                    recognition.onend = () => { DOM.micButton.classList.remove('recording'); isRecording = false; };
                } else { recognition.stop(); DOM.micButton.classList.remove('recording'); isRecording = false; }
            }

            // =================================================================== //
            //                      10. CLIPBOARD & HELPERS
            // =================================================================== //

            function copyToClipboard(text) {
                const textOnly = text.replace(/```(\w+)?\n?([\s\S]*?)```/g, '');
                navigator.clipboard.writeText(textOnly).then(() => showToast(translate('toast_answer_copied')));
            }
            
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('.copy-code-btn');
                if (btn) { const code = decodeURIComponent(btn.getAttribute('data-code')); navigator.clipboard.writeText(code).then(() => showToast(translate('toast_code_copied'))); }
            });

        })();
    </script>
</body>
</html>