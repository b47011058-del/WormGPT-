<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>WormGPT v2.5</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&family=Fira+Code:wght@400;600&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark-reasonable.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --bg-core: #050505; --accent-primary: #ff0033; --accent-glow: rgba(255, 0, 51, 0.4); --text-main: #e0e0e0; --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background-color: var(--bg-core); color: var(--text-main); font-family: 'Cairo', sans-serif; height: 100dvh; overflow: hidden; background-image: radial-gradient(circle at 50% 0%, #1a0005 0%, #000000 80%); user-select: none; }
        .msg-bubble { user-select: text; }
        body::after { content: ""; position: absolute; inset: 0; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%); background-size: 100% 4px; pointer-events: none; z-index: 9999; opacity: 0.6; }
        #chat-wrapper { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; z-index: 10; }
        .chat-header { padding: calc(10px + var(--safe-top)) 15px 10px 15px; display: flex; justify-content: space-between; align-items: center; background: rgba(10, 0, 0, 0.95); border-bottom: 1px solid #330000; backdrop-filter: blur(10px); }
        #title { font-family: 'Orbitron', sans-serif; font-size: 1.2rem; color: var(--accent-primary); text-shadow: 0 0 10px var(--accent-glow); }
        .header-btn { width: 38px; height: 38px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); color: #ccc; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; min-width: 44px; min-height: 44px; }
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 30px; scroll-behavior: smooth; }
        #welcome-screen { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.8; overflow-y: auto; padding: 20px 0; }
        #welcome-screen i.main-icon { font-size: 4rem; color: var(--accent-primary); margin-bottom: 20px; animation: pulse 3s infinite; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        .suggestions { display: grid; gap: 10px; width: 100%; max-width: 650px; margin-top: 30px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        .sug-card { background: rgba(255,255,255,0.03); border: 1px solid #333; padding: 12px; border-radius: 8px; font-size: 0.9rem; display: flex; gap: 10px; align-items: center; cursor: pointer; transition: 0.2s; min-height: 44px; }
        .sug-card:hover { background: rgba(255, 0, 51, 0.1); border-color: var(--accent-primary); }
        .message { max-width: 92%; margin-bottom: 20px; display: flex; flex-direction: column; position: relative; }
        .msg-bubble { padding: 12px 16px; border-radius: 12px; font-size: 0.95rem; line-height: 1.6; word-wrap: break-word; }
        .msg-user { align-self: flex-end; margin-left: auto; }
        .msg-user .msg-bubble { background: linear-gradient(145deg, #80001a, #4d000f); color: #fff; border-bottom-left-radius: 2px; }
        .msg-bot { align-self: flex-start; margin-right: auto; width: 100%; }
        .msg-bot .msg-bubble { background: #111; border: 1px solid #2a2a2a; color: #ddd; border-bottom-right-radius: 2px; }
        .msg-actions { display: flex; justify-content: flex-end; gap: 10px; padding: 5px 10px; margin-top: 5px; opacity: 0.7; }
        .msg-action-btn { background: none; border: none; color: #888; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 5px; font-family: 'Cairo'; min-height: 32px; padding: 0 8px; }
        .msg-action-btn:hover { color: var(--accent-primary); }
        .msg-bot strong { color: #fff; } .msg-bot h1, .msg-bot h2, .msg-bot h3 { color: var(--accent-primary); margin-top: 15px; font-family: 'Orbitron'; }
        .code-wrapper { margin: 12px 0; border: 1px solid #333; border-radius: 6px; overflow: hidden; background: #1e1e1e; direction: ltr; text-align: left; }
        .code-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #252525; border-bottom: 1px solid #333; font-family: 'Fira Code'; font-size: 0.8rem; color: #aaa; }
        .copy-code-btn { border: none; background: rgba(255,255,255,0.1); color: #fff; cursor: pointer; font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; min-height: 28px; }
        .copy-code-btn:hover { background: var(--accent-primary); }
        pre { padding: 15px; overflow-x: auto; margin: 0; } code { font-family: 'Fira Code', monospace; font-size: 0.85rem; }
        .input-wrapper { background: rgba(0, 0, 0, 0.95); border-top: 1px solid #222; padding: 10px; padding-bottom: calc(10px + var(--safe-bottom)); position: sticky; bottom: 0; z-index: 30; }
        .input-box { display: flex; align-items: flex-end; gap: 8px; background: #151515; border-radius: 20px; padding: 6px 12px; border: 1px solid #333; }
        .input-box:focus-within { border-color: var(--accent-primary); }
        textarea { flex: 1; background: transparent; border: none; color: #fff; padding: 8px 0; font-size: 1rem; max-height: 120px; resize: none; font-family: 'Cairo'; }
        .action-btn { width: 36px; height: 36px; border-radius: 50%; border: none; background: transparent; color: #666; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: 0.2s; min-width: 44px; min-height: 44px; }
        .send-btn { background: var(--accent-primary); color: white; margin-bottom: 2px; }
        .send-btn:disabled { background: #333; color: #555; }
        .mic-active { color: #ff0033 !important; animation: micPulse 1s infinite; }
        @keyframes micPulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        #sidebar { position: fixed; top: 0; right: 0; width: 80%; max-width: 300px; height: 100%; background: #0a0a0a; border-left: 1px solid #222; z-index: 100; transform: translateX(100%); transition: 0.3s; display: flex; flex-direction: column; padding-top: var(--safe-top); }
        #sidebar.active { transform: translateX(0); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 90; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(2px); }
        .overlay.active { opacity: 1; pointer-events: auto; }
        .chat-item { padding: 15px; border-bottom: 1px solid #151515; color: #999; display: flex; justify-content: space-between; min-height: 44px; align-items: center; }
        .chat-item.active { background: #1a0505; color: #fff; border-left: 3px solid var(--accent-primary); }
        @media (max-width: 480px) { .chat-header { padding: calc(8px + var(--safe-top)) 12px 8px 12px; } #title { font-size: 1.1rem; } .message { max-width: 95%; } .msg-bubble { padding: 10px 14px; font-size: 0.9rem; } }
    </style>
</head>
<body>
    <div id="chat-wrapper">
        <header class="chat-header">
            <button onclick="app.newChat()" class="header-btn"><i class="fas fa-plus"></i></button>
            <div id="title">WORM<span style="color:#fff">GPT</span></div>
            <button onclick="app.toggleMenu()" class="header-btn"><i class="fas fa-bars"></i></button>
        </header>
        <div id="chat-box">
            <div id="welcome-screen">
                <i class="fas fa-biohazard main-icon"></i>
                <h2 style="font-family:'Orbitron'">WormGPT v2.5</h2>
                <p style="color:#666;">مشفر. سريع. آمن.</p>
                <div class="suggestions">
                    <div class="sug-card" onclick="app.setInput('أكتب كود بايثون لفحص المنافذ المفتوحة (Port Scanner)')"><i class="fab fa-python"></i> <span>فحص الشبكات (Python)</span></div>
                    <div class="sug-card" onclick="app.setInput('كيفية استغلال ثغرات نواة Linux القديمة')"><i class="fab fa-linux"></i> <span>استغلال ثغرات Kernel</span></div>
                    <div class="sug-card" onclick="app.setInput('شرح كيفية تنفيذ هجوم SQL Injection يدوياً')"><i class="fas fa-database"></i> <span>حقن قواعد البيانات (SQLi)</span></div>
                    <div class="sug-card" onclick="app.setInput('كيفية تحليل ملف EXE مشبوه واستخراج النصوص منه')"><i class="fas fa-microchip"></i> <span>الهندسة العكسية</span></div>
                    <div class="sug-card" onclick="app.setInput('كود تشفير وفك تشفير الملفات Ransomware style')"><i class="fas fa-file-code"></i> <span>تشفير الملفات</span></div>
                    <div class="sug-card" onclick="app.setInput('أدوات كسر حماية WPA2 Handshake')"><i class="fas fa-wifi"></i> <span>اختراق شبكات WiFi</span></div>
                </div>
            </div>
        </div>
        <div class="input-wrapper">
            <form class="input-box" onsubmit="event.preventDefault(); app.send();">
                <button type="button" onclick="app.exportChat()" class="action-btn" style="font-size:0.9rem"><i class="fas fa-camera"></i></button>
                <button type="button" id="btn-mic" onclick="app.toggleVoice()" class="action-btn"><i class="fas fa-microphone"></i></button>
                <textarea id="msg-input" placeholder="اكتب هنا..." rows="1"></textarea>
                <button type="submit" id="btn-send" class="action-btn send-btn" disabled><i class="fas fa-arrow-up"></i></button>
            </form>
        </div>
    </div>
    <div class="overlay" onclick="app.toggleMenu()"></div>
    <nav id="sidebar">
        <div style="padding:20px; border-bottom:1px solid #222; color:var(--accent-primary); font-weight:bold; display:flex; justify-content:space-between;"><span>السجلات</span> <i class="fas fa-times" onclick="app.toggleMenu()"></i></div>
        <div id="history-list" style="flex:1; overflow-y:auto;"></div>
    </nav>
    <script>
        document.addEventListener('keydown',e=>{if(e.key==='F12'||(e.ctrlKey&&e.shiftKey&&(e.key==='I'||e.key==='C'||e.key==='J'))||(e.ctrlKey&&e.key==='u'))e.preventDefault()});
        document.addEventListener('contextmenu',e=>e.preventDefault());

        const app = (function() {
            const CONF = { API: "https://yojagahyhoogwtfpvtok.supabase.co/functions/v1/chat", KEY: "wgpt_a9a48e5xh95hujecpbpmdv", LIMIT: 5 };
            const state = { history: [], chats: JSON.parse(localStorage.getItem('worm_chats')) || [], activeId: null, processing: false };
            const els = { box: document.getElementById('chat-box'), input: document.getElementById('msg-input'), btnSend: document.getElementById('btn-send'), btnMic: document.getElementById('btn-mic'), welcome: document.getElementById('welcome-screen'), sidebar: document.getElementById('sidebar'), overlay: document.querySelector('.overlay'), histList: document.getElementById('history-list') };

            // --- Security & Limit Logic (Obfuscated) ---
            const _sec = {
                k: '_sys_core_v2_config', // اسم مموه للمتغير
                getFP: () => {
                    // إنشاء بصمة جهاز فريدة (Fingerprint) لمنع التلاعب عبر مسح الكاش
                    const cvs = document.createElement('canvas');
                    const ctx = cvs.getContext('2d');
                    ctx.font = "16px Arial"; ctx.fillText("worm_sig_" + window.navigator.userAgent, 5, 20);
                    let hash = 0, str = cvs.toDataURL() + (screen.height * screen.width);
                    for (let i = 0; i < str.length; i++) { hash = ((hash << 5) - hash) + str.charCodeAt(i); hash |= 0; }
                    return "uid_" + Math.abs(hash).toString(16);
                },
                get: function() {
                    const fp = this.getFP();
                    const today = new Date().toISOString().split('T')[0];
                    // محاولة القراءة من مصادر متعددة (LS, Cookies)
                    let d = localStorage.getItem(this.k);
                    if(!d) { // إذا تم المسح، حاول الاسترجاع من الكوكيز
                         const m = document.cookie.match(new RegExp('(^| )'+this.k+'=([^;]+)'));
                         if(m) d = atob(m[2]);
                    }
                    
                    let obj = d ? JSON.parse(d) : { d: today, c: 0, uid: fp };
                    
                    // إذا اختلف التاريخ، تصفير العداد
                    if (obj.d !== today) { obj = { d: today, c: 0, uid: fp }; this.save(obj); }
                    // التحقق من تطابق الجهاز (لمنع نسخ الكود لجهاز آخر بنفس البيانات)
                    if (obj.uid !== fp) { obj.uid = fp; } 
                    
                    return obj;
                },
                save: function(obj) {
                    const s = JSON.stringify(obj);
                    // التخزين في LocalStorage
                    localStorage.setItem(this.k, s);
                    // التخزين في Cookies (مع صلاحية طويلة جداً) كنسخة احتياطية
                    const exp = new Date(); exp.setFullYear(exp.getFullYear() + 1);
                    document.cookie = `${this.k}=${btoa(s)}; expires=${exp.toUTCString()}; path=/; SameSite=Strict`;
                },
                check: function() {
                    const info = this.get();
                    if (info.c >= CONF.LIMIT) return false;
                    return true;
                },
                inc: function() {
                    const info = this.get();
                    info.c++;
                    this.save(info);
                }
            };
            // -------------------------------------------

            marked.setOptions({ breaks: true, highlight: (code, lang) => highlight.highlight(code, { language: highlight.getLanguage(lang) ? lang : 'plaintext' }).value });

            function init() {
                const lastId = localStorage.getItem('worm_last_id');
                if (lastId && state.chats.find(c => c.id == lastId)) loadChat(lastId); else newChat();
                els.input.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = Math.min(this.scrollHeight, 120) + 'px'; els.btnSend.disabled = !this.value.trim(); });
                renderHistory();
            }

            async function send() {
                const txt = els.input.value.trim();
                if (!txt || state.processing) return;

                // ⛔ التحقق من الحد المسموح
                if (!_sec.check()) {
                    appendMsg('bot', `⚠️ **تم رفض الوصول:** تجاوزت الحد اليومي المسموح به (${CONF.LIMIT} رسائل). \n\n_Reset Time: 00:00 GMT_`);
                    els.input.value = '';
                    return;
                }

                state.processing = true; els.input.value = ''; els.btnSend.disabled = true; els.welcome.style.display = 'none';
                appendMsg('user', txt);
                _sec.inc(); // زيادة العداد

                const currentChat = state.chats.find(c => c.id == state.activeId);
                if(currentChat) { if(!currentChat.msgs.length) { currentChat.title = txt.substring(0, 20); renderHistory(); } currentChat.msgs.push({ role: 'user', content: txt }); saveData(); }

                const loadId = appendLoader();
                try {
                    const res = await fetch(CONF.API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ api_key: CONF.KEY, message: txt, session_id: state.activeId }) });
                    document.getElementById(loadId)?.remove();
                    if (!res.ok) throw new Error();
                    const data = await res.json();
                    const reply = data.response || data.answer || "No response.";
                    appendMsg('bot', reply);
                    if(currentChat) { currentChat.msgs.push({ role: 'assistant', content: reply }); saveData(); }
                } catch (err) { document.getElementById(loadId)?.remove(); appendMsg('bot', '⚠️ فشل الاتصال.'); } finally { state.processing = false; }
            }

            function appendMsg(role, text) {
                const div = document.createElement('div'); div.className = `message ${role === 'user' ? 'msg-user' : 'msg-bot'}`;
                const bubble = document.createElement('div'); bubble.className = 'msg-bubble';
                if (role === 'user') { bubble.textContent = text; div.appendChild(bubble); } 
                else {
                    const contentDiv = document.createElement('div'); contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(text));
                    contentDiv.querySelectorAll('pre code').forEach((block) => {
                        const wrapper = document.createElement('div'); wrapper.className = 'code-wrapper';
                        const header = document.createElement('div'); header.className = 'code-header';
                        header.innerHTML = `<span>${(block.className||'text').replace('language-','')}</span><button class="copy-code-btn" onclick="app.copy(this, '${btoa(unescape(encodeURIComponent(block.innerText)))}')"><i class="far fa-copy"></i> نسخ</button>`;
                        wrapper.appendChild(header); wrapper.appendChild(block.parentElement.cloneNode(true)); block.parentElement.replaceWith(wrapper);
                    });
                    bubble.appendChild(contentDiv); div.appendChild(bubble);
                }
                els.box.appendChild(div); els.box.scrollTop = els.box.scrollHeight;
            }

            function appendLoader() { const id = 'l_' + Date.now(); const d = document.createElement('div'); d.id=id; d.className='message msg-bot'; d.innerHTML='<div class="msg-bubble"><i class="fas fa-circle-notch fa-spin"></i></div>'; els.box.appendChild(d); return id; }
            function copy(btn, b64) { navigator.clipboard.writeText(decodeURIComponent(escape(atob(b64)))); btn.innerHTML='<i class="fas fa-check"></i>'; setTimeout(()=>btn.innerHTML='<i class="far fa-copy"></i> نسخ',2000); }
            
            function toggleVoice() {
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition; if (!SR) return alert("غير مدعوم");
                if (state.rec && state.recing) { state.rec.stop(); return; }
                state.rec = new SR(); state.rec.lang = 'ar-SA';
                state.rec.onstart = () => { state.recing = true; els.btnMic.classList.add('mic-active'); els.input.placeholder = "تحدث..."; };
                state.rec.onend = () => { state.recing = false; els.btnMic.classList.remove('mic-active'); els.input.placeholder = "اكتب..."; };
                state.rec.onresult = (e) => { els.input.value += ' ' + e.results[0][0].transcript; els.input.dispatchEvent(new Event('input')); };
                state.rec.start();
            }

            function newChat() { state.activeId = Date.now().toString(); state.chats.unshift({ id: state.activeId, title: 'جلسة جديدة', msgs: [], date: Date.now() }); els.box.innerHTML = ''; els.box.appendChild(els.welcome); els.welcome.style.display = 'flex'; saveData(); renderHistory(); toggleMenu(false); }
            function loadChat(id) { state.activeId = id; localStorage.setItem('worm_last_id', id); const chat = state.chats.find(c => c.id == id); if(!chat) return newChat(); els.box.innerHTML = ''; if(chat.msgs.length) { els.welcome.style.display = 'none'; chat.msgs.forEach(m => appendMsg(m.role, m.content)); } else { els.box.appendChild(els.welcome); els.welcome.style.display = 'flex'; } toggleMenu(false); }
            function delChat(e, id) { e.stopPropagation(); if(!confirm('حذف؟')) return; state.chats = state.chats.filter(c => c.id != id); saveData(); if(state.activeId == id) newChat(); else renderHistory(); }
            function saveData() { localStorage.setItem('worm_chats', JSON.stringify(state.chats)); localStorage.setItem('worm_last_id', state.activeId); }
            function renderHistory() { els.histList.innerHTML = state.chats.map(c => `<div class="chat-item ${c.id == state.activeId?'active':''}" onclick="app.loadChat('${c.id}')"><span>${c.title}</span><i class="fas fa-trash" onclick="app.delChat(event, '${c.id}')"></i></div>`).join(''); }
            function toggleMenu(f) { els.sidebar.classList.toggle('active', f!==undefined?f:!els.sidebar.classList.contains('active')); els.overlay.classList.toggle('active', f!==undefined?f:!els.overlay.classList.contains('active')); }
            function setInput(t) { els.input.value = t; els.input.dispatchEvent(new Event('input')); send(); }
            function exportChat() { html2canvas(els.box, { backgroundColor: '#050505', ignoreElements: n => n.id === 'welcome-screen' && n.style.display === 'none' }).then(c => { const l = document.createElement('a'); l.download = `WormGPT-${Date.now()}.png`; l.href = c.toDataURL(); l.click(); }); }

            return { init, send, newChat, loadChat, delChat, toggleMenu, toggleVoice, setInput, exportChat, copy };
        })();
        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
